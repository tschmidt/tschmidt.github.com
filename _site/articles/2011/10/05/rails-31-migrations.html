<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<title>SchmidtHappens | Rails 3.1 - Changes in Migrations</title>
	<meta name="author" content="Terry Schmidt">
	
	<link href='http://plus.google.com/103688769817504697011/' rel='author'/>
  <link href='/css/normalize.css' rel='stylesheet'>
  <link href='/css/site.css' rel='stylesheet'>
  <link href='/css/responsive.css' rel='stylesheet'>
  <link rel="stylesheet" href="/css/pygments-friendly.css">
  
  
	<script src="/js/libs/modernizr-2.0.min.js"></script>
	<script src="/js/libs/respond.min.js"></script>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  
  <header role='main'>
    <div class='container'>
      <a href='/' class='pull-left'>
        <h1>
          Schmidt<span>Happens</span>
        </h1>
      </a>

      <nav role="navigation" class='pull-right'>
        <ul>
          <li id="n-articles">
            <a href='/articles'>
              Articles
            </a>
          </li>
          <li id="n-tips">
            <a href='/tips'>
              Tips
            </a>
          </li>
          <li id="n-about">
            <a href='/about'>
              About
            </a>
          </li>
          <li id="n-projects">
            <a href='/projects'>
              Projects
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>
  
  <div class='container article-container'>
    <article>
  <header>
  <h2 class='article-title large'>Rails 3.1 - Changes in Migrations</h2>
</header>
<aside class='article-meta fullpage'>
  <ul class='unstyled'>
    <li class="date"><strong>05 Oct 2011</strong></li>
    <li class="tags">articles, how to, migrations, rails, and rails 3.1</li>
  </ul>
</aside>
<p>With the release of Rails 3.1, a lot has changed. Migrations saw quite a few changes that I really like and I wanted to share them here. Migrations have always been one of my favorite parts of Rails because they make managing your database tables a breeze and with Rails 3.1 it gets even easier.<span id="continue"></span></p>
  <p>
    Migrations in Rails 3.1 has moved the #up and #down methods to instance methods
    instead of class methods. This just feels better to me when writing migrations.
  </p>
  
  <div class="highlight"><pre><code class="ruby"><span class="lineno">1</span> <span class="k">class</span> <span class="nc">MyAwesomeMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
<span class="lineno">2</span>     <span class="k">def</span> <span class="nf">up</span>
<span class="lineno">3</span>       <span class="c1"># some change you want to make goes here</span>
<span class="lineno">4</span>     <span class="k">end</span>
<span class="lineno">5</span>   
<span class="lineno">6</span>     <span class="k">def</span> <span class="nf">down</span>
<span class="lineno">7</span>       <span class="c1"># revert the change you made in the up action</span>
<span class="lineno">8</span>     <span class="k">end</span>
<span class="lineno">9</span>   <span class="k">end</span></code></pre></div>
  
  <p>
    Then, the Rails team took it one step further. Since most migrations are
    just doing the reverse in the down action as what was done in the up action
    they have introduced the #change action. When defined in your migration
    this combines both the up and down actions into a single method call.
  </p>
  
  <p>I. Heart. This.</p>
  
  <p>
    It always felt like 90% of the migrations that I was writing didn't need
    a separate definition for the down action. I wanted Rails to just figure
    out that "if I'm creating a table in the up, then drop it in the down" or
    "if I'm adding a column then remove it" or "if I'm changing a column then
    change it back". Well, now that happens for us thanks to the new
    <a href="https://github.com/rails/rails/blob/master/activerecord/lib/active_record/migration/command_recorder.rb">ActiveRecord::Migration::CommandRecorder</a> class.
    I've added a few examples to show you how simple your migrations can
    now be.
  </p>
  
  <div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="c1"># Add/Drop a table</span>
<span class="lineno"> 2</span>   <span class="k">class</span> <span class="nc">MyAwesomeMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
<span class="lineno"> 3</span>     <span class="k">def</span> <span class="nf">change</span>
<span class="lineno"> 4</span>       <span class="n">create_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
<span class="lineno"> 5</span>         <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:first_name</span>
<span class="lineno"> 6</span>         <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:last_name</span>
<span class="lineno"> 7</span>         <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
<span class="lineno"> 8</span>       <span class="k">end</span>
<span class="lineno"> 9</span>     <span class="k">end</span>
<span class="lineno">10</span>   <span class="k">end</span>
<span class="lineno">11</span>   
<span class="lineno">12</span>   <span class="c1"># Add/Remove a table column</span>
<span class="lineno">13</span>   <span class="k">class</span> <span class="nc">MyAwesomeMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
<span class="lineno">14</span>     <span class="k">def</span> <span class="nf">change</span>
<span class="lineno">15</span>       <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">:date</span>
<span class="lineno">16</span>     <span class="k">end</span>
<span class="lineno">17</span>   <span class="k">end</span>
<span class="lineno">18</span>   
<span class="lineno">19</span>   <span class="c1"># Rename a column in a table</span>
<span class="lineno">20</span>   <span class="k">class</span> <span class="nc">MyAwesomeMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
<span class="lineno">21</span>     <span class="k">def</span> <span class="nf">change</span>
<span class="lineno">22</span>       <span class="n">rename_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">:birthday</span>
<span class="lineno">23</span>       <span class="c1"># This one is a bit interesting because when the reverse is called</span>
<span class="lineno">24</span>       <span class="c1"># the arguments you specify are simply reversed. So this would be the &quot;down&quot;</span>
<span class="lineno">25</span>       <span class="c1"># action</span>
<span class="lineno">26</span>       <span class="c1">#</span>
<span class="lineno">27</span>       <span class="c1">#    rename_column :users, :birthday, :birthdate</span>
<span class="lineno">28</span>     <span class="k">end</span>
<span class="lineno">29</span>   <span class="k">end</span></code></pre></div>
  
  <p>
    Obviously, not everything can be reversed. For example, how would you
    logically reverse removing a column? At first you might think "that's easy, 
    just call add_column on the down action". The only problem with that is
    when you call `remove_column' you don't specify the type for the column.
    That means when the `add_column' action is called it will fail. Not to worry,
    Rails will alert you if you have tried to do something it has deemed
    irreversible. An `IrreversibleMigration' exception will be raised.
  </p>
  
  <p>
    Here is a list of the actions that are auto-magically reversed. The reverse
    action is given inside the parenthesis:
    
    <ul>
      <li>add_column (remove_column)</li>
      <li>add_index (remove_index)</li>
      <li>add_timestamps (remove_timestamps)</li>
      <li>create_table (drop_table)</li>
      <li>remove_timestamps (add_timestamps)</li>
      <li>rename_column</li>
      <li>rename_index</li>
      <li>rename_table</li>
    </ul>
  </p>
  
  <p>
    Another change that was made to keep in line with the new #change method
    is that when you create a migration from a constructive migration generator,
    the change method will be used in place of the up and down methods. Wondering
    what a "constructive migration generator" is? Here's and example:
  </p>
  
  <div class="highlight"><pre><code class="console"><span class="gp">#</span><span class="o">=</span>&gt; rails g migration AddFirstNameToUsers first_name:string</code></pre></div>
  
  <div class="highlight"><pre><code class="ruby"><span class="lineno">1</span> <span class="c1"># The following migration is created</span>
<span class="lineno">2</span>   <span class="k">class</span> <span class="nc">AddFirstNameToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
<span class="lineno">3</span>     <span class="k">def</span> <span class="nf">change</span>
<span class="lineno">4</span>       <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:string</span>
<span class="lineno">5</span>     <span class="k">end</span>
<span class="lineno">6</span>   <span class="k">end</span></code></pre></div>
  
  <p>
    And there you have it. Migrations in Rails 3.1 are even more awesome than
    they used to be. So get out there and try these techniques for yourself.
  </p>
  
  <p>Something missing? Need more explanation? Let me know in the <accronym title="For those of you that are fans of the klassic Killer Instict video game, that was for you.">c-c-c-comments</accronym>!</p>
</article>
    
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'schmidthappensgh'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </div>
	
  <footer role="main">
    <div class='container'>
      <section class="comp about main">
        <header>
          <h2 class='article-title'>Sometimes...schmidt happens</h2>
        </header>
        <p>
          Schmidt<span>Happens</span> is the personal blog of Terry Schmidt. Here you will
          find articles on programming, design, culture and life. Explore.
          Enjoy. Spread the word.
        </p>
      </section>
      
      <div class='well-container'>
        <section class="well">
          <header>
            <h3>Currently on my bookshelf</h3>
          </header>
          <ul>
            
            <li>
              <a href='http://www.abookapart.com/products/html5-for-web-designers' target='_blank'>HTML5 for Web Designers</a> by
              
                <a href='http://adactio.com' target='_blank'>Jeremy Keith</a>
              
              
              
            </li>
            
            <li>
              <a href='http://www.poodr.com' target='_blank'>Practical Object Oriented Design in Ruby: An Agile Primer</a> by
              
                <a href='https://twitter.com/sandimetz' target='_blank'>Sandi Metz</a>
              
              
              
            </li>
            
            <li>
              <a href='http://www.abookapart.com/products/the-elements-of-content-strategy' target='_blank'>The Elements of Content Strategy</a> by
              
                <a href='http://incisive.nu/about/' target='_blank'>Erin Kissane</a>
              
              
              
            </li>
            
            <li>
              <a href='' target='_blank'>Rails 4 in Action</a> by
              
              
              
                
                  <a href='http://ryanbigg.com' target='_blank'>Ryan Bigg</a>, 
                
                  <a href='http://yehudakatz.com' target='_blank'>Yehuda Katz</a> and 
                
                  <a href='http://words.steveklabnik.com' target='_blank'>Steve Klabnik</a>
                
              
            </li>
            
          </ul>
        </section>
        
        <section class="well">
          <header>
            <h3>Sites &amp; Resources</h3>
          </header>
          <ul class='unstyled'>
            
              <li>
                <a href='http://www.fontsquirrel.com' target='_blank' title='Handpicked fonts for graphic designers'>Font Squirrel</a>
              </li>
            
              <li>
                <a href='http://google.com/fonts' target='_blank' title='Hundreds of free, open-source fonts optimized for the web'>Google Web Fonts</a>
              </li>
            
              <li>
                <a href='http://necolas.github.io/normalize.css/' target='_blank' title='Make browsers render all elements more consistently'>normalize.css</a>
              </li>
            
          </ul>
        </section>
        
        <section class="well">
          <header>
            <h3>Stalk Me</h3>
          </header>
          <ul class='unstyled'>
            
              <li>
                <a href='https://twitter.com/tschmidt' target='_blank' title='The personal twitter account for Terry Schmidt'>twitter/tschmidt</a>
              </li>
            
              <li>
                <a href='https://twitter.com/linkluv' target='_blank' title='The twitter account I use to show some link love'>twitter/linkluv</a>
              </li>
            
              <li>
                <a href='https://github.com/tschmidt' target='_blank' title='A collection of projects I work on'>github/tschmidt</a>
              </li>
            
          </ul>
        </section>
      </div>
    </div>
  </footer>
	
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/libs/jquery-1.6.2.min.js"><\/script>')</script>

<!-- scripts concatenated and minified via ant build script-->
<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>
<!-- end scripts-->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-26092524-1', 'schmidt-happens.com');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>

<!--[if lt IE 7 ]>
	<script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1.0.2/CFInstall.min.js"></script>
	<script>window.attachEvent("onload",function(){CFInstall.check({mode:"overlay"})})</script>
<![endif]-->

</body>
</html>
